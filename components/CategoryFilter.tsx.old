"use client";

import { Category } from "@/lib/types";
import { useRouter, useSearchParams, usePathname } from "next/navigation";
import { useState, useEffect } from "react";

interface CategoryFilterProps {
  categories: Category[];
  activeCategorySlugs?: string[];
}

export default function CategoryFilter({
  categories,
  activeCategorySlugs = [],
}: CategoryFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const pathname = usePathname();
  const [selectedCategories, setSelectedCategories] =
    useState<string[]>(activeCategorySlugs);

  // Sync state with props whenever they change (including after navigation)
  useEffect(() => {
    console.log(
      "CategoryFilter - activeCategorySlugs changed:",
      activeCategorySlugs
    );
    setSelectedCategories(activeCategorySlugs);
  }, [activeCategorySlugs.join(",")]); // Use join as dependency to properly detect array changes

  const handleCategoryToggle = (categorySlug: string) => {
    let newSelected: string[];

    if (selectedCategories.includes(categorySlug)) {
      // Remove category
      newSelected = selectedCategories.filter((slug) => slug !== categorySlug);
    } else {
      // Add category
      newSelected = [...selectedCategories, categorySlug];
    }

    console.log("CategoryFilter - toggling category:", categorySlug);
    console.log("CategoryFilter - new selection:", newSelected);

    setSelectedCategories(newSelected);

    // Build URL
    if (newSelected.length === 0) {
      // No categories selected, go to /collections
      const params = new URLSearchParams(searchParams.toString());
      params.delete("page"); // Reset to page 1
      const search = params.toString();
      const targetUrl = `/collections${search ? `?${search}` : ""}`;
      console.log("CategoryFilter - navigating to:", targetUrl);
      router.push(targetUrl);
      router.refresh(); // Force refresh to ensure server component updates
    } else {
      // Navigate to /collections/[category] with multiple categories
      const params = new URLSearchParams(searchParams.toString());
      params.delete("page"); // Reset to page 1
      const search = params.toString();
      const categoryPath = newSelected.join(",");
      const targetUrl = `/collections/${categoryPath}${
        search ? `?${search}` : ""
      }`;
      console.log("CategoryFilter - navigating to:", targetUrl);
      router.push(targetUrl);
      router.refresh(); // Force refresh to ensure server component updates
    }
  };

  const clearFilters = () => {
    setSelectedCategories([]);
    const params = new URLSearchParams(searchParams.toString());
    params.delete("page");
    const search = params.toString();
    router.push(`/collections${search ? `?${search}` : ""}`);
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 sticky top-24">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-poppins font-bold text-xl text-black">
          Categories
        </h3>
        {selectedCategories.length > 0 && (
          <button
            onClick={clearFilters}
            className="text-sm text-primary hover:underline"
          >
            Clear All
          </button>
        )}
      </div>

      <div className="space-y-3">
        {categories.map((category) => (
          <label
            key={category.id}
            className="flex items-center space-x-3 cursor-pointer group"
          >
            <input
              type="checkbox"
              checked={selectedCategories.includes(category.slug)}
              onChange={() => handleCategoryToggle(category.slug)}
              className="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2 cursor-pointer"
            />
            <span className="text-base text-gray-700 group-hover:text-primary transition-colors">
              {category.name}
            </span>
          </label>
        ))}
      </div>
    </div>
  );
}
